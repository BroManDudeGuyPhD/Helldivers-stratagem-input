# Copilot Instructions — Helldivers Stratagem Input

## Project Overview
A single-file PowerShell tool (`automagic-democracy.ps1`) that automates Helldivers 2 stratagem keypresses. It reads stratagem codes from `democracy.json` and uses `System.Windows.Forms.SendKeys` to inject keystrokes into the game. Windows-only; no build system or tests.

## Architecture & Data Flow
```
democracy.json  →  Learn-Keypress()  →  Enter-Keypress()  →  SendKeys → Game
                   (lookup by Name/Alias)   (CTRL + arrow keys)
```
- `democracy.json` schema: `Democracy.Stratagems[]` — each entry has `Name`, `Alias`, `Code` (UDLR string), `Cooldown`, `Uses`, `ActivationTime`. Mission stratagems may have empty `Cooldown`/`ActivationTime` if the source table has fewer columns.
- `Update-Json` calls the Fandom **MediaWiki API** (`https://helldivers.fandom.com/api.php?action=parse&page=Stratagem_Codes&prop=wikitext&format=json`) to get raw wikitext, bypassing Cloudflare entirely. Arrow directions are encoded as `{{U}}`, `{{D}}`, `{{L}}`, `{{R}}` templates in the wikitext and parsed directly with `[regex]::Matches`. No `ParsedHtml` needed — works in both PS5.1 and PS7. The Ship Modules section is stubbed/commented out.
- `$stratagesmDataFile = "democracy.json"` is a **relative path** — the script must be run from its own directory, or this variable updated.

## Entry Points (script parameters)
| Parameter | Alias(es) | Behavior |
|---|---|---|
| `-strat "Name"` | `-stratagem`, `-code`, `-strategem` | Look up code and inject keypresses |
| `-update` | — | Scrape wiki and regenerate `democracy.json` |
| `-terminal` | `-test`, `-testing`, `-help` | Interactive menu (default if no param given) |
| `-setup` | `-init`, `-initialize` | UTF-8 encoding check/instructions |

```powershell
# Direct use (script on PATH):
automagic-democracy -strat "Autocannon"
# Full path (required for HASS.Agent / CMD callers):
powershell.exe -File "C:\path\automagic-democracy.ps1" -strat "Orbital Laser"
```

## Stratagem Lookup Logic (`Learn-Keypress`)
1. Exact match on `Name` or `Alias`
2. Falls back to `.Contains()` substring match on both fields
3. If `democracy.json` is missing, shows a WPF `MessageBox` prompting to run `-update`

Alias convention: names like `AC-8 Autocannon` auto-generate alias `Autocannon` by splitting on `-` and taking the second word onward. Names without `-` use the full name as alias.

## Keypress Injection (`Enter-Keypress`)
- Sends `^` (CTRL) once, then loops UDLR characters → arrow key SendKeys codes.
- `$keypressWaitTime = 70` ms between each arrow press — tune this if inputs are missed.
- **Game setting requirement**: In-game "Stratagem Input Type" must be set to **Press**, not Hold.

## Vanity / UI Layer
`Vanity-Text`, `Vanity-Tab`, `Vanity-NewLine`, `Vanity-Logo`, `Get-Funky` are display-only helpers. They add a typewriter effect and box-drawing border characters (`█`, `━`). UTF-8 encoding must be enabled system-wide (via `intl.cpl` → Beta UTF-8 option) for these to render correctly. Changes to logic should not depend on these functions.

## Required .NET Assemblies
```powershell
Add-Type -AssemblyName microsoft.VisualBasic
Add-Type -AssemblyName System.Windows.Forms      # SendKeys
Add-Type -AssemblyName PresentationCore, PresentationFramework  # MessageBox
```

## Key Files
- [`automagic-democracy.ps1`](../automagic-democracy.ps1) — entire script (~600 lines)
- [`democracy.json`](../democracy.json) — stratagem data (~700 lines, 100+ stratagems); **never hand-edit** — it is solely generated by `Update-Json` scraping the wiki
- [`README.md`](../README.md) — voice control setup (Alexa/Home Assistant/HASS.Agent flow)

## Planned / Incomplete Features
- **Ship Modules scraping** in `Update-Json` — actively planned; commented-out skeleton targets `https://helldivers.fandom.com/wiki/Super_Destroyer` and parses `<p>` and `<ul>` tags for module name, description, effect, and sample cost. The `$ModuleList` and `$DataFileJson.Democracy` merge are already wired; only the scraping logic needs restoring.
- **"Stratagem Hero" game mode** (menu option 4) — stub only; more complex, not actively in progress.
- **Vanity disable setting** — mentioned in comments, not implemented.
